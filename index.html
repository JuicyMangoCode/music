<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>ðŸŽ§ Music Library</title>
		<link
			href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600&display=swap"
			rel="stylesheet"
		/>
		<style>
			:root {
				--primary: #03a9f4;
				--background: #121212;
				--surface: #1e1e1e;
				--text: #ffffff;
				--text-muted: #bbbbbb;
				--border: #2a2a2a;
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				font-family: 'Roboto', sans-serif;
				background-color: var(--background);
				color: var(--text);
				padding: 2rem;
			}

			h1 {
				font-weight: 600;
				color: var(--primary);
				margin-bottom: 1.5rem;
				font-size: 2rem;
			}

			.search-bar {
				margin-bottom: 2rem;
			}

			input[type='text'] {
				width: 100%;
				padding: 0.75rem 1rem;
				font-size: 1rem;
				border-radius: 8px;
				border: 1px solid var(--border);
				background-color: var(--surface);
				color: var(--text);
				transition: border-color 0.3s ease;
			}

			input[type='text']:focus {
				border-color: var(--primary);
				outline: none;
			}

			.file-list {
				display: grid;
				gap: 1rem;
			}
			
			.file-card {
				background-color: var(--surface);
				border-radius: 8px;
				padding: 1rem 1.2rem;
				transition: background 0.3s ease;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.file-card:hover {
				background-color: #2a2a2a;
			}

			.file-name {
				color: var(--text);
				font-size: 1rem;
				font-weight: 500;
				word-break: break-all;
			}

			.file-link {
				text-decoration: none;
				color: var(--primary);
				font-size: 0.9rem;
				cursor: pointer;
			}

			.no-results {
				color: var(--text-muted);
				font-style: italic;
			}

			@media (max-width: 600px) {
				body {
					padding: 1rem;
				}
			}
		</style>
	</head>
	<body>
		<h1>ðŸŽ§ Music Library</h1>

		<div class="search-bar">
			<input type="text" id="search" placeholder="Search music..." />
		</div>

		<div id="music-list" class="file-list">Loading...</div>

		<script>
			const user = 'JuicyMangoCode';
			const repo = 'music';
			const branch = 'main';
			const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/music_assets?ref=${branch}`;
			let allFiles = [];

			// Fetch latest commit message for a file and extract SHORT_URL
			async function fetchShortUrlForFile(filename) {
				const commitsApi = `https://api.github.com/repos/${user}/${repo}/commits?path=music_assets/${filename}&sha=${branch}`;
				try {
					const res = await fetch(commitsApi);
					if (!res.ok) return null;
					const commits = await res.json();
					if (!Array.isArray(commits) || commits.length === 0) return null;

					const commitMessage = commits[0]?.commit?.message || '';
					const match = commitMessage.match(/SHORT_URL:\s*(https?:\/\/\S+)/);
					if (match) return match[1];
				} catch {
					return null;
				}
				return null;
			}

			async function displayFiles(files) {
				const container = document.getElementById('music-list');
				container.innerHTML = '';

				if (files.length === 0) {
					container.innerHTML =
						'<p class="no-results">No matching MP3 files found.</p>';
					return;
				}

				for (const file of files) {
					const card = document.createElement('div');
					card.className = 'file-card';

					const name = document.createElement('div');
					name.className = 'file-name';
					name.textContent = file.name;

					const actions = document.createElement('div');
					actions.style.display = 'flex';
					actions.style.gap = '0.75rem';

					const fullUrl = `https://${user}.github.io/${repo}/music_assets/${file.name}`;
					const shortUrl = await fetchShortUrlForFile(file.name);

					const openLink = document.createElement('a');
					openLink.className = 'file-link';
					openLink.href = shortUrl || fullUrl;
					openLink.target = '_blank';
					openLink.rel = 'noopener noreferrer';
					openLink.textContent = 'Open';

					const copyLink = document.createElement('a');
					copyLink.className = 'file-link';
					copyLink.href = '#';
					copyLink.textContent = 'Copy';
					copyLink.onclick = (e) => {
						e.preventDefault();
						const textToCopy = shortUrl || fullUrl;
						navigator.clipboard
							.writeText(textToCopy)
							.then(() => {
								copyLink.textContent = 'Copied!';
								setTimeout(() => {
									copyLink.textContent = 'Copy';
								}, 2000);
							})
							.catch(() => {
								copyLink.textContent = 'Failed!';
							});
					};

					actions.appendChild(openLink);
					actions.appendChild(copyLink);
					card.appendChild(name);
					card.appendChild(actions);
					container.appendChild(card);
				}
			}

			fetch(apiUrl)
				.then((res) => res.json())
				.then(async (data) => {
					allFiles = data.filter((f) => f.name.toLowerCase().endsWith('.mp3'));
					await displayFiles(allFiles);
				})
				.catch((err) => {
					console.error(err);
					document.getElementById('music-list').textContent =
						'Failed to load file list.';
				});

			document.getElementById('search').addEventListener('input', function () {
				const query = this.value.toLowerCase();
				const filtered = allFiles.filter((file) =>
					file.name.toLowerCase().includes(query)
				);
				displayFiles(filtered);
			});
		</script>
	</body>
</html>
